name: Fast Deploy Docs to zwiki.ztrader.ai

on:
  push:
    branches: [ main ]
    paths:
      - "docs/**"
      - "static/**"
      - "sidebars.js"
      - "docusaurus.config.*"
      - ".github/workflows/deploy.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§­ Checkout latest repo
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - run: corepack enable
      - run: corepack use pnpm@10.18.2

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Lint MDX to catch illegal "<digit" before build
        run: |
          if grep -RIn -E '<\s*[0-9]' docs; then
            echo "âŒ Found illegal '<digit' pattern in docs (like <0.5). Use &lt; or backticks instead."
            exit 1
          fi

      - name: ğŸ—ï¸ Build Docusaurus
        run: pnpm build

      - name: ğŸ§³ Compress build artifacts
        run: tar -C build -czf build.tar.gz .

      - name: ğŸš€ Deploy to zwiki.ztrader.ai via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail

            echo "ğŸ“‚ Preparing temp directories..."
            mkdir -p /var/www/zknowledge/_incoming
            rm -rf /var/www/zknowledge/_incoming/build.tar.gz || true

      - name: ğŸ“¤ Upload build artifact to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "build.tar.gz"
          target: "/var/www/zknowledge/_incoming/"

      - name: ğŸ”„ Extract and atomically replace current version
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail

            TMP=/var/www/zknowledge/_tmp_out
            DST=/var/www/zknowledge/out
            SRC=/var/www/zknowledge/_incoming/build.tar.gz

            echo "ğŸ§© Unpacking new build..."
            rm -rf "$TMP"
            mkdir -p "$TMP"
            tar -C "$TMP" -xzf "$SRC"

            echo "ğŸ”‘ Setting permissions..."
            chown -R www-data:www-data "$TMP"

            echo "ğŸ” Swapping directories atomically..."
            mv -T "$TMP" "$DST"

            echo "âœ… Deployed successfully at $(date -u +%FT%TZ)" > "$DST/DEPLOYED_AT.txt"
